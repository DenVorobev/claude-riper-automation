#!/bin/bash

# RIPER Workflow Enforcement Pre-commit Hook
# Ensures RIPER workflow compliance before allowing commits
# This hook validates:
# 1. Plan exists (architectural/complex tasks only)
# 2. Review phase completed
# 3. Tests passing
# 4. No TypeScript errors
# 5. No uncommitted changes in key files

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

repo_root=$(git rev-parse --show-toplevel 2>/dev/null || echo ".")
branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "main")
memory_bank="$repo_root/.claude/memory-bank"

echo -e "${BLUE}üîç RIPER Workflow Validation (Pre-commit)${NC}"
echo ""

# Check 1: If memory bank exists, validate workflow
if [ -d "$memory_bank" ]; then
  plans_dir="$memory_bank/$branch/plans"
  reviews_dir="$memory_bank/$branch/reviews"

  # If there are plans on this branch, check that review exists
  if [ -d "$plans_dir" ] && [ "$(ls -1 "$plans_dir"/*.md 2>/dev/null | wc -l)" -gt 0 ]; then
    echo -e "${YELLOW}üìã Found RIPER plans on this branch${NC}"

    if [ ! -d "$reviews_dir" ] || [ "$(ls -1 "$reviews_dir"/*.md 2>/dev/null | wc -l)" -eq 0 ]; then
      echo -e "${RED}‚ùå WORKFLOW INCOMPLETE: Review phase not found!${NC}"
      echo ""
      echo -e "You have RIPER plans but no review. Run:${NC}"
      echo -e "  ${BLUE}/riper:review${NC}"
      echo ""
      echo "Or bypass this check with:"
      echo "  git commit --no-verify"
      exit 1
    else
      echo -e "${GREEN}‚úì Review phase found${NC}"
    fi
  fi
fi

# Check 2: Run tests if npm project
if [ -f "$repo_root/package.json" ]; then
  if grep -q '"test"' "$repo_root/package.json"; then
    echo -e "${YELLOW}üß™ Running tests...${NC}"
    if ! npm test 2>&1 | tail -5; then
      echo -e "${RED}‚ùå Tests failed!${NC}"
      exit 1
    fi
    echo -e "${GREEN}‚úì Tests passing${NC}"
  fi
fi

# Check 3: Type check if TypeScript project
if [ -f "$repo_root/tsconfig.json" ]; then
  echo -e "${YELLOW}üìù Type checking TypeScript...${NC}"
  if ! npx tsc --noEmit 2>&1 | tail -5; then
    echo -e "${RED}‚ùå TypeScript errors found!${NC}"
    exit 1
  fi
  echo -e "${GREEN}‚úì No TypeScript errors${NC}"
fi

# Check 4: Validate no large files being committed
large_files=$(git diff --cached --name-only --diff-filter=A | while read file; do
  size=$(stat -f%z "$repo_root/$file" 2>/dev/null || echo 0)
  if [ "$size" -gt 10485760 ]; then  # 10MB
    echo "$file"
  fi
done)

if [ -n "$large_files" ]; then
  echo -e "${RED}‚ùå Large files detected in commit:${NC}"
  echo "$large_files"
  exit 1
fi

echo ""
echo -e "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
exit 0
