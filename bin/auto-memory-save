#!/bin/bash

# Auto-save architectural decisions to Memory Bank
# Improvement #1: Automatic saving of important decisions
# Trigger: PostToolUse hook (after Write/Edit operations)

set -e

# Color codes
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get input from stdin or argument
input="${1:-$(cat)}"

# Return early for simple acknowledgments
if echo "$input" | grep -iE "^(ok|Ð³Ð¾Ñ‚Ð¾Ð²Ð¾|Ð¿Ð¾Ð½ÑÐ»|yes|Ð´Ð°|Ð½ÐµÑ‚|no|thanks|ÑÐ¿Ð°ÑÐ¸Ð±Ð¾|thanks|thanks you)$" > /dev/null; then
  exit 0
fi

# Skip if input is empty
if [ -z "$input" ]; then
  exit 0
fi

# Keywords for CRITICAL importance (architecture, security, payments)
critical_keywords="Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€|Ð´Ð¸Ð·Ð°Ð¹Ð½|Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼|Ð²Ñ‹Ð±Ð¸Ñ€Ð°ÐµÐ¼|Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½|auth|security|payment|stripe|postgresql|database|Ð¼Ð¾Ð½Ð¾Ñ€ÐµÐ¿Ð¾|monorepo|Ð¼Ð¸ÐºÑ€Ð¾ÑÐµÑ€Ð²Ð¸Ñ|microservice|oauth|jwt|encryption|ÑˆÐ¸Ñ„Ñ€"

# Keywords for HIGH importance (integrations, bugs, business logic)
high_keywords="Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð¸Ñ€ÑƒÐµÐ¼|api|webhook|Ð¸ÑÐ¿Ñ€Ð°Ð²Ð¸Ð»Ð¸|Ð±Ð°Ð³|bug|ÑÐµÑ€ÑŒÑ‘Ð·Ð½Ñ‹Ð¹|serious|Ð°Ð»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼|algorithm|performance|Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·"

# Keywords for MEDIUM importance (features, refactoring)
medium_keywords="feature|Ñ„Ð¸Ñ‡Ð°|ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°|command|function|Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ|Ð¼Ð¾Ð´ÑƒÐ»ÑŒ|module|refactor|Ñ€ÐµÑ„Ð°ÐºÑ‚Ð¾Ñ€Ð¸Ð½Ð³|Ñ‚ÐµÑÑ‚|test"

# Determine importance level
importance="none"

if echo "$input" | grep -iE "$critical_keywords" > /dev/null; then
  importance="critical"
elif echo "$input" | grep -iE "$high_keywords" > /dev/null; then
  importance="high"
elif echo "$input" | grep -iE "$medium_keywords" > /dev/null; then
  # Only save medium if it's substantial (>50 chars)
  if [ ${#input} -gt 50 ]; then
    importance="medium"
  fi
fi

# If not important enough, don't save
if [ "$importance" = "none" ]; then
  exit 0
fi

# Show indication that we're saving
case "$importance" in
  "critical")
    echo -e "${GREEN}ðŸ’¾ Auto-saving CRITICAL decision to Memory Bank${NC}"
    echo -e "${BLUE}Decision detected:${NC} $(echo "$input" | head -c 60)..."
    ;;
  "high")
    echo -e "${YELLOW}ðŸ’¾ Auto-saving HIGH importance to Memory Bank${NC}"
    ;;
  "medium")
    echo -e "${YELLOW}ðŸ’¾ Auto-saving MEDIUM importance to Memory Bank${NC}"
    ;;
esac

# Create timestamp
timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
date_str=$(date -u +"%Y%m%d")

# Get current git branch
branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "main")

# Create directory structure if needed
repo_root=$(git rev-parse --show-toplevel 2>/dev/null || echo ".")
memory_dir="$repo_root/.claude/memory-bank/$branch/sessions"
mkdir -p "$memory_dir" 2>/dev/null || true

# Create session file with decision
session_file="$memory_dir/$date_str-auto-save.md"

# If file exists, append to it
if [ -f "$session_file" ]; then
  cat >> "$session_file" << EOF

## Auto-saved Decision ($(date '+%H:%M:%S'))

**Importance:** $importance

**Decision:**
$input

**Context:** Auto-detected from user action
**Timestamp:** $timestamp
EOF
else
  cat > "$session_file" << EOF
# Auto-saved Decisions - $date_str

## Auto-saved Decision ($(date '+%H:%M:%S'))

**Importance:** $importance

**Decision:**
$input

**Context:** Auto-detected from user action
**Timestamp:** $timestamp
EOF
fi

# Log success (brief)
echo -e "${GREEN}âœ… Saved to Memory Bank${NC}"

exit 0
